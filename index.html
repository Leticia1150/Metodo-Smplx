<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>App Simplex Mejorada</title>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<style>
  body {
    max-width: 900px;
    margin: 20px auto;
    font-family: Arial, sans-serif;
    padding: 0 15px;
  }
  h1 {
    text-align: center;
  }
  label {
    font-weight: bold;
    margin-top: 10px;
    display: block;
  }
  input[type=text], input[type=number], select {
    width: 100%;
    padding: 8px;
    margin-top: 5px;
    box-sizing: border-box;
  }
  .flex-row {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }
  .flex-row > * {
    flex: 1;
    min-width: 100px;
  }
  button {
    background-color: #007bff;
    color: white;
    font-weight: bold;
    border: none;
    padding: 12px 20px;
    margin-top: 20px;
    cursor: pointer;
    border-radius: 5px;
  }
  button:disabled {
    background-color: #aaa;
    cursor: not-allowed;
  }
  #formularioDatos {
    margin-top: 20px;
    display: none;
  }
  .error {
    color: red;
    font-weight: bold;
    margin-top: 5px;
  }
  #grafico {
    margin-top: 40px;
  }
</style>
</head>
<body>

<h1>Aplicación Simplex Mejorada</h1>

<div>
  <label for="numVariables">Número de variables (mínimo 2):</label>
  <input type="number" id="numVariables" min="2" value="2" />

  <label for="numRestricciones">Número de restricciones (mínimo 1):</label>
  <input type="number" id="numRestricciones" min="1" value="2" />

  <button id="btnGenerar">Generar Campos</button>
</div>

<form id="formularioDatos">
  <div id="nombresVariablesDiv" style="margin-top:15px;">
    <label>Nombres personalizados para las variables (ej: x, y, z):</label>
    <div id="nombresVariables"></div>
  </div>

  <div style="margin-top:15px;">
    <label for="tipoProblema">Tipo de problema:</label>
    <select id="tipoProblema">
      <option value="max">Maximizar</option>
      <option value="min">Minimizar</option>
    </select>
  </div>

  <fieldset style="margin-top:20px;">
    <legend><b>Función Objetivo (Z):</b></legend>
    <div id="funcionObjetivo" class="flex-row"></div>
  </fieldset>

  <fieldset style="margin-top:20px;">
    <legend><b>Restricciones:</b></legend>
    <div id="restricciones"></div>
  </fieldset>

  <button type="button" id="btnResolver">Resolver</button>
</form>

<div id="mensajesError" class="error"></div>
<div id="resultado"></div>
<div id="grafico"></div>

<script>
const numVariablesInput = document.getElementById('numVariables');
const numRestriccionesInput = document.getElementById('numRestricciones');
const btnGenerar = document.getElementById('btnGenerar');
const formularioDatos = document.getElementById('formularioDatos');
const nombresVariablesDiv = document.getElementById('nombresVariables');
const funcionObjetivoDiv = document.getElementById('funcionObjetivo');
const restriccionesDiv = document.getElementById('restricciones');
const btnResolver = document.getElementById('btnResolver');
const mensajesErrorDiv = document.getElementById('mensajesError');
const resultadoDiv = document.getElementById('resultado');
const graficoDiv = document.getElementById('grafico');
const tipoProblemaSelect = document.getElementById('tipoProblema');

let nombresVariables = [];

btnGenerar.addEventListener('click', () => {
  mensajesErrorDiv.textContent = '';
  let nVars = parseInt(numVariablesInput.value);
  let nRes = parseInt(numRestriccionesInput.value);

  if(isNaN(nVars) || nVars < 2) {
    mensajesErrorDiv.textContent = 'Por favor, ingresa al menos 2 variables.';
    return;
  }
  if(isNaN(nRes) || nRes < 1) {
    mensajesErrorDiv.textContent = 'Por favor, ingresa al menos 1 restricción.';
    return;
  }

  generarNombresVariables(nVars);
  generarFuncionObjetivo(nVars);
  generarRestricciones(nVars, nRes);

  formularioDatos.style.display = 'block';
});

function generarNombresVariables(n) {
  nombresVariablesDiv.innerHTML = '';
  nombresVariables = [];
  for(let i=0; i<n; i++) {
    const input = document.createElement('input');
    input.type = 'text';
    input.placeholder = `Variable ${i+1} (ej: x, y)`;
    input.value = ['x','y','z','w','v'][i] || `x${i+1}`;
    input.addEventListener('input', validarNombresVariables);
    nombresVariablesDiv.appendChild(input);
    nombresVariables.push(input);
  }
}

function validarNombresVariables() {
  let nombreSet = new Set();
  let error = '';
  for(let input of nombresVariables) {
    let val = input.value.trim();
    if(!val.match(/^[a-zA-Z][a-zA-Z0-9]*$/)) {
      error = 'Los nombres de variables deben comenzar con letra y contener solo letras y números.';
      break;
    }
    if(nombreSet.has(val)) {
      error = 'Los nombres de variables deben ser únicos.';
      break;
    }
    nombreSet.add(val);
  }
  mensajesErrorDiv.textContent = error;
}

function generarFuncionObjetivo(n) {
  funcionObjetivoDiv.innerHTML = '';
  for(let i=0; i<n; i++) {
    const input = document.createElement('input');
    input.type = 'number';
    input.step = 'any';
    input.placeholder = `Coeficiente de ${['x','y','z'][i] || 'x'+(i+1)}`;
    funcionObjetivoDiv.appendChild(input);
  }
}

function generarRestricciones(nVars, nRes) {
  restriccionesDiv.innerHTML = '';
  for(let i=0; i<nRes; i++) {
    const div = document.createElement('div');
    div.className = 'flex-row';
    div.style.marginBottom = '10px';

    for(let j=0; j<nVars; j++) {
      const input = document.createElement('input');
      input.type = 'number';
      input.step = 'any';
      input.placeholder = `Coef. de ${['x','y','z'][j] || 'x'+(j+1)}`;
      div.appendChild(input);
    }

    const selectSigno = document.createElement('select');
    ['≤','≥','='].forEach(s => {
      const option = document.createElement('option');
      option.value = s;
      option.textContent = s;
      selectSigno.appendChild(option);
    });
    div.appendChild(selectSigno);

    const inputLadoDerecho = document.createElement('input');
    inputLadoDerecho.type = 'number';
    inputLadoDerecho.step = 'any';
    inputLadoDerecho.placeholder = 'Lado derecho';
    div.appendChild(inputLadoDerecho);

    restriccionesDiv.appendChild(div);
  }
}

btnResolver.addEventListener('click', () => {
  const a = parseFloat(restriccionesDiv.children[0].children[0].value);
  const b = parseFloat(restriccionesDiv.children[0].children[1].value);
  const c = parseFloat(restriccionesDiv.children[0].children[3].value);

  const d = parseFloat(restriccionesDiv.children[1].children[0].value);
  const e = parseFloat(restriccionesDiv.children[1].children[1].value);
  const f = parseFloat(restriccionesDiv.children[1].children[3].value);

  let puntos = [
    { x: 0, y: 0 },
    { x: 0, y: c / b },
    { x: c / a, y: 0 },
    { x: 0, y: f / e },
    { x: f / d, y: 0 },
  ];

  puntos = puntos.filter(p => a * p.x + b * p.y <= c && d * p.x + e * p.y <= f);
  const interX = (c * e - f * b) / (a * e - b * d);
  const interY = (a * f - d * c) / (a * e - b * d);
  if (!isNaN(interX) && !isNaN(interY)) {
    puntos.push({ x: interX, y: interY });
  }

  puntos = puntos.filter(p => p.x >= 0 && p.y >= 0);

  const coefX = parseFloat(funcionObjetivoDiv.children[0].value);
  const coefY = parseFloat(funcionObjetivoDiv.children[1].value);

  let optimo = null;
  let zMax = tipoProblemaSelect.value === 'max' ? -Infinity : Infinity;

  for (let p of puntos) {
    let z = coefX * p.x + coefY * p.y;
    if ((tipoProblemaSelect.value === 'max' && z > zMax) ||
        (tipoProblemaSelect.value === 'min' && z < zMax)) {
      zMax = z;
      optimo = p;
    }
  }

  resultadoDiv.innerHTML = `<h3>Solución óptima:</h3>
    <p>x = ${optimo.x.toFixed(2)}</p>
    <p>y = ${optimo.y.toFixed(2)}</p>
    <p>Z = ${zMax.toFixed(2)}</p>`;

  const factibleX = puntos.map(p => p.x);
  const factibleY = puntos.map(p => p.y);

  Plotly.newPlot('grafico', [
    {
      x: factibleX.concat(factibleX[0]),
      y: factibleY.concat(factibleY[0]),
      fill: 'toself',
      type: 'scatter',
      name: 'Zona factible',
      fillcolor: 'rgba(0, 128, 255, 0.3)',
      line: { color: 'blue' }
    },
    {
      x: [optimo.x],
      y: [optimo.y],
      type: 'scatter',
      mode: 'markers+text',
      name: 'Punto óptimo',
      marker: { color: 'red', size: 10 },
      text: [`Z=${zMax.toFixed(2)}`],
      textposition: 'top right'
    }
  ], {
    title: 'Región factible y solución óptima',
    xaxis: { title: nombresVariables[0].value },
    yaxis: { title: nombresVariables[1].value }
  });
});
</script>

</body>
</html>
